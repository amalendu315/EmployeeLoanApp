@inherits LayoutComponentBase
@using Microsoft.AspNetCore.Components.Authorization
@using EmployeeLoanApp.Services
@inject AuthService AuthService
@inject NavigationManager Nav

<MudThemeProvider Theme="_crmTheme" />
<MudDialogProvider />
<MudSnackbarProvider />
<MudPopoverProvider />

<AuthorizeView>
    <!-- AUTHORIZED LAYOUT (Dashboard) -->
    <Authorized>
        <MudLayout>
            <MudAppBar Elevation="1" Color="Color.Surface" Fixed="true" Class="border-b-2">
                <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Primary" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
                <MudText Typo="Typo.h5" Color="Color.Primary" Class="ml-3" Style="font-weight:600;">Loan CRM</MudText>
                <MudSpacer />

                <!-- User Profile & Logout -->
                <div class="d-flex align-center gap-4">
                    <MudText Color="Color.Secondary" Typo="Typo.body2"><b>@context.User.Identity?.Name</b></MudText>
                    <MudAvatar Color="Color.Primary" Variant="Variant.Filled">
                        @context.User.Identity?.Name?.Substring(0, 1).ToUpper()
                    </MudAvatar>
                    <MudTooltip Text="Logout">
                        <MudIconButton Icon="@Icons.Material.Filled.Logout" Color="Color.Error" OnClick="HandleLogout" />
                    </MudTooltip>
                </div>
            </MudAppBar>

            <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
                <MudNavMenu>
                    <MudText Typo="Typo.subtitle2" Class="pa-4">MAIN MENU</MudText>
                    <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">Dashboard</MudNavLink>
                    <MudNavLink Href="/apply" Icon="@Icons.Material.Filled.NoteAdd">New Application</MudNavLink>
                    @* <MudNavLink Href="/admin" Icon="@Icons.Material.Filled.AdminPanelSettings">Approvals (HR)</MudNavLink> *@
                    <MudNavLink Href="/employees" Icon="@Icons.Material.Filled.People">Team Directory</MudNavLink>

                    <MudText Typo="Typo.subtitle2" Class="pa-4 mt-4">REPORTS & SETTINGS</MudText>
                    <MudNavLink Href="/reports" Icon="@Icons.Material.Filled.Assessment">Reports</MudNavLink>
                    <MudNavLink Href="/masters" Icon="@Icons.Material.Filled.Settings">Master Data</MudNavLink>

                    @if (context.User.IsInRole("SuperAdmin"))
                    {
                        <MudNavLink Href="/admin-users" Icon="@Icons.Material.Filled.SupervisedUserCircle">Manage Admins</MudNavLink>
                    }
                </MudNavMenu>
            </MudDrawer>

            <MudMainContent Class="mud-background-gray">
                <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
                    @Body
                </MudContainer>
            </MudMainContent>
        </MudLayout>
    </Authorized>

    <!-- NOT AUTHORIZED LAYOUT (Login Screen) -->
    <NotAuthorized>
        <div class="d-flex justify-center align-center" style="min-height: 100vh; background-color: #F8FAFC;">
            <!-- Renders the Login page directly -->
            <EmployeeLoanApp.Components.Pages.Login />
        </div>
    </NotAuthorized>
</AuthorizeView>

@code {
    bool _drawerOpen = true;
    void DrawerToggle() => _drawerOpen = !_drawerOpen;

    private async Task HandleLogout()
    {
        // Change AuthService.Logout() to this:
        await AuthService.LogoutAsync();
        Nav.NavigateTo("/", forceLoad: true);
    }

    private MudTheme _crmTheme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = "#6EC1E4",
            Secondary = "#54595F",
            TextPrimary = "#54595F",
            TextSecondary = "#7A7A7A",
            Success = "#61CE70",
            Info = "#4054B2",
            Background = "#F3F5F7",
            Surface = "#FFFFFF",
            AppbarBackground = "#FFFFFF"
        },
        Typography = new Typography()
        {
            Default = new DefaultTypography() { FontFamily = new[] { "Open Sans", "Helvetica", "Arial", "sans-serif" } }
        }
    };
}