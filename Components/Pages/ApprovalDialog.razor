@using EmployeeLoanApp.Services
@using EmployeeLoanApp.Models
@inject LoanService LoanService
@inject IWebHostEnvironment Env
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <div class="d-flex align-center">
            <MudIcon Icon="@Icons.Material.Filled.VerifiedUser" Class="mr-3" Color="Color.Success" Size="Size.Large" />
            <div>
                <MudText Typo="Typo.h6">Sanction Loan Application</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">Reference ID: #@ApplicationId</MudText>
            </div>
        </div>
    </TitleContent>
    <DialogContent>
        <MudContainer Class="pa-0" Style="min-height: 400px;">
            <!-- Applicant Info Banner -->
            <MudPaper Elevation="0" Class="pa-3 mb-4 rounded-lg d-flex justify-space-between align-center" Style="background-color: #F0F7FF; border: 1px solid #CCE5FF;">
                <div class="d-flex align-center">
                    <MudAvatar Color="Color.Primary" Size="Size.Small" Class="mr-3">@ApplicantName.Substring(0, 1)</MudAvatar>
                    <div>
                        <MudText Typo="Typo.body2"><b>@ApplicantName</b></MudText>
                        <MudText Typo="Typo.caption" Color="Color.Primary">Applicant</MudText>
                    </div>
                </div>
                <div class="text-right">
                    <MudText Typo="Typo.caption">Requested</MudText>
                    <MudText Typo="Typo.body2"><b>₹@RequestedAmount.ToString("N0")</b></MudText>
                </div>
            </MudPaper>

            <!-- TABS FOR BETTER UI/UX -->
            <MudTabs Elevation="0" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pt-4" Color="Color.Primary">

                <!-- TAB 1: VERIFICATION & AUTHORITY -->
                <MudTabPanel Text="1. Authority" Icon="@Icons.Material.Filled.Security">
                    <MudGrid>
                        <MudItem xs="12"><MudText Typo="Typo.subtitle2" Color="Color.Default"><b>Verification Details</b></MudText></MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="approval.VerifiedBy" Label="Verified By (HR)" Variant="Variant.Outlined" Margin="Margin.Dense" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.PersonOutline" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField Value="@DateTime.Now.ToShortDateString()" Label="Date" Variant="Variant.Outlined" Margin="Margin.Dense" ReadOnly="true" />
                        </MudItem>

                        <MudItem xs="12" Class="mt-2"><MudText Typo="Typo.subtitle2" Color="Color.Default"><b>Sanctioning Authority</b></MudText></MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="approval.ApprovingAuthorityName" Label="Authority Name" Variant="Variant.Outlined" Margin="Margin.Dense" HelperText="e.g. Director" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudTextField @bind-Value="approval.ApprovingAuthorityDesignation" Label="Designation" Variant="Variant.Outlined" Margin="Margin.Dense" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- TAB 2: FINANCIALS -->
                <MudTabPanel Text="2. Financials" Icon="@Icons.Material.Filled.AttachMoney">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2">Ensure these values match the final agreement.</MudAlert>
                        </MudItem>
                        <MudItem xs="6">
                            <MudNumericField @bind-Value="approval.SanctionedAmount" Label="Sanctioned Amount (₹)" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.CurrencyRupee" />
                        </MudItem>
                        <MudItem xs="6">
                            <MudNumericField @bind-Value="approval.ApprovedTenureMonths" Label="Approved Tenure (Months)" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudNumericField @bind-Value="approval.SanctionedEMIAmount" Label="Monthly EMI Amount (₹)" Variant="Variant.Outlined" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.PieChart" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- TAB 3: DOCUMENTATION -->
                <MudTabPanel Text="3. Finalize" Icon="@Icons.Material.Filled.AssignmentTurnedIn">
                    <MudGrid>
                        <MudItem xs="12">
                            <MudTextField @bind-Value="approval.AdminComments" Label="Admin Comments / Remarks" Variant="Variant.Outlined" Lines="4" Placeholder="Enter any internal notes or conditions..." />
                        </MudItem>

                        <MudItem xs="12">
                            <MudText Typo="Typo.subtitle2" Class="mb-2"><b>Proof of Approval</b></MudText>
                            <MudFileUpload T="IBrowserFile" FilesChanged="UploadFile">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Outlined"
                                               Color="@(fileName == null ? Color.Secondary : Color.Success)"
                                               StartIcon="@Icons.Material.Filled.CloudUpload"
                                               FullWidth="true"
                                               Class="py-4 dashed-border">
                                        @(fileName ?? "Click to Upload Approval Email (PDF)")
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
            </MudTabs>
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="SubmitApproval" StartIcon="@Icons.Material.Filled.CheckCircle" Class="px-6">Confirm Sanction</MudButton>
    </DialogActions>
</MudDialog>

<style>
    .dashed-border {
        border: 2px dashed var(--mud-palette-divider);
        transition: all 0.3s;
    }

        .dashed-border:hover {
            border-color: var(--mud-palette-primary);
            background-color: var(--mud-palette-action-hover);
        }
</style>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public int ApplicationId { get; set; }
    [Parameter] public decimal RequestedAmount { get; set; }
    [Parameter] public string ApplicantName { get; set; } = "Unknown";

    private LoanApproval approval = new();
    private string? fileName;

    protected override void OnInitialized()
    {
        approval.ApplicationID = ApplicationId;
        approval.SanctionedAmount = RequestedAmount;
    }

    private async Task UploadFile(IBrowserFile file)
    {
        if (file == null) return;

        fileName = file.Name;
        var folderPath = Path.Combine(Env.WebRootPath, "uploads");
        Directory.CreateDirectory(folderPath);

        var uniqueName = $"{Guid.NewGuid()}_{fileName}";
        var path = Path.Combine(folderPath, uniqueName);

        using var fs = new FileStream(path, FileMode.Create);
        await file.OpenReadStream(maxAllowedSize: 5000000).CopyToAsync(fs); // 5MB limit

        approval.ApprovalProofAttachmentPath = uniqueName;
    }

    private async Task SubmitApproval()
    {
        // Basic Validation
        if (approval.SanctionedAmount <= 0 || approval.ApprovedTenureMonths <= 0)
        {
            // You could inject ISnackbar here to show a warning
            Snackbar.Add("Loan Approved Successfully", Severity.Warning);
            return;
        }

        await LoanService.ApproveLoanAsync(approval);
        MudDialog.Close(DialogResult.Ok(true));
    }

    void Cancel() => MudDialog.Cancel();
}